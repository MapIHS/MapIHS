const { Client, LocalAuth } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');

// masukin/import module fs
const fs = require('fs')

// Create a new client instance
const client = new Client({
    authStrategy: new LocalAuth(),
    puppeteer: {
        args: ['--no-sandbox', '--disable-setuid-sandbox'],
    }
}
);

// buat variable untuk baca database
let users = {};
if (fs.existsSync('absensi.json')) {
    const db = fs.readFileSync('absensi.json', 'utf-8');
    users = db ? JSON.parse(db) : {};
}

function saveDb(data) {
    fs.writeFileSync('absensi.json', JSON.stringify(data, null, 2), "utf-8");
}

// When the client is ready, run this code (only once)
client.once('ready', () => {
    console.log('Client is ready!');
});

// When the client received QR-Code
client.on('qr', (qr) => {
    console.log('QR RECEIVED', qr);
    qrcode.generate(qr, { small: true });
});

client.on('message_create', message => {
    if (message.body === '!menu') {
        // reply back "pong" directly to the message
        message.reply(`*List Perintah*
            
*!absen*
*!listabsen*
            `);
    }


    if (message.body === "!absen") {

        const today = new Date().toLocaleDateString("id-ID")
        const time = new Date().toLocaleTimeString("id-ID")

        // Inisialisasi data hari ini kalau belum ada
        if (!users[today]) {
            users[today] = {};
        }

        // Cek apakah user sudah absen
        if (users[today][message.from]) {
            message.reply(
                "âŒ Anda sudah absen hari ini pada pukul " + users[today][message.from].time
            );
        } else {
            // Simpan absen baru
            const contact = message._data.notifyName || message.from;
            users[today][message.from] = {
                name: contact,
                time: time,
                timestamp: new Date(),
            };

            saveDb(users); // simpan ke file

            message.reply(
                "âœ… Absensi berhasil! \nTerima kasih " +
                contact +
                ", Anda telah absen pada " +
                time
            );
        }
    }

    if (message.body === "!listabsen") {
        const today = new Date().toLocaleDateString("id-ID");

        if (!users[today] || Object.keys(users[today]).length === 0) {
            return message.reply("ğŸ“… " + today + "\nBelum ada yang absen.");
        }

        let i = 1;
        let daftar = Object.entries(users[today])
            .map(([user, data]) => `${i++}. ${data.name} (${user}) ğŸ•’ ${data.time}`)
            .join("\n");

        message.reply("ğŸ“‹ Daftar Absensi\nğŸ“… " + today + "\n\n" + daftar);
    }

});

// Start your client
client.initialize();
